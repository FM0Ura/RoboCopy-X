# ?? Sistema de Progresso em Tempo Real - RoboCopy-X

## Visão Geral

O RoboCopy-X exibe uma **barra de progresso visual com porcentagem e informações em tempo real** durante as operações de transferência de arquivos, mostrando:
- ? Porcentagem de progresso (0-100%)
- ? Nome do arquivo sendo copiado no momento
- ? Tempo estimado restante
- ? Contador de arquivos (quando disponível)

## ?? Interface de Progresso Atualizada

### Componentes Visuais

A seção de progresso inclui:

1. **Barra de Progresso**
   - Barra visual que preenche de 0% a 100%
   - Altura: 10px para melhor visibilidade
   - Cor de destaque do tema (accent color)
   - Bordas arredondadas (5px) para design moderno
   - **Atualização em tempo real** conforme Robocopy processa

2. **Porcentagem Numérica**
   - Texto grande (16px) e em negrito ao lado da barra
   - Formato: "X.X%" (com uma casa decimal)
   - Cor de destaque para fácil leitura
   - **Atualização instantânea** (sem atraso)

3. **Status da Operação** ? NOVO
   - Mostra o **arquivo atual sendo copiado**
   - Formato: "?? Copiando: nome_do_arquivo.ext"
   - Trunca nomes longos (máximo 50 caracteres)
   - Ícones visuais para fácil identificação:
     - ?? = Copiando arquivo
     - ?? = Tempo estimado
     - ? = Concluído

4. **Detalhes Extras** ? NOVO
   - Contador de arquivos: "Arquivo 45 de 120"
   - Aparece quando disponível
   - Atualização em tempo real

## ?? Detecção de Arquivos em Tempo Real

### Múltiplos Padrões Regex

O sistema usa **3 padrões diferentes** para capturar nomes de arquivos:

#### Pattern 1: Formato Padrão do Robocopy
```regex
^\s*(?:New File|Newer|Older|same|modified|\*EXTRA File)\s+[\d\.,]+\s*[KMG]?B?\s+(.+)$
```

**Captura:**
```
          New File              1.2 MB        documento.pdf
                                              ? captura isto
```

#### Pattern 2: Caminho Completo
```regex
[A-Za-z]:\\(?:[^\\/:*?""<>|\r\n]+\\)*([^\\/:*?""<>|\r\n]+\.\w+)
```

**Captura:**
```
C:\Source\Folder\arquivo.txt
                 ? captura apenas o nome
```

#### Pattern 3: Arquivo no Final da Linha
```regex
\s+([^\s]+\.\w{2,4})\s*$
```

**Captura:**
```
                                         arquivo.doc
                                         ? captura isto
```

### Fluxo de Detecção

```
???????????????????????????????????????????
? Robocopy escreve na saída               ?
? "    New File    1.2 MB   arquivo.txt"  ?
???????????????????????????????????????????
                  ?
                  ?
???????????????????????????????????????????
? OutputDataReceived captura linha        ?
? e.Data = "    New File    1.2 MB ..."   ?
???????????????????????????????????????????
                  ?
                  ?
???????????????????????????????????????????
? Testa Pattern 1 (formato padrão)        ?
? ? Match! fileName = "arquivo.txt"      ?
???????????????????????????????????????????
                  ?
                  ?
???????????????????????????????????????????
? _processedFiles++ (contador)            ?
? _processedFiles = 45                    ?
???????????????????????????????????????????
                  ?
                  ?
???????????????????????????????????????????
? UpdateProgressStatus()                  ?
? "?? Copiando: arquivo.txt"              ?
???????????????????????????????????????????
                  ?
                  ?
???????????????????????????????????????????
? Atualiza ProgressDetailsText            ?
? "Arquivo 45 de 120"                     ?
???????????????????????????????????????????
```

## ?? Exemplo Visual

### Interface Durante Cópia

```
???????????????????????????????????????????????????????
? Executar Operação                                   ?
???????????????????????????????????????????????????????
?  [Executar]   [Cancelar]                            ?
???????????????????????????????????????????????????????
?                                                      ?
?  ??????????????????????????????  62.3%              ?
?                                                      ?
?  ?? Copiando: relatorio_mensal_dezembro_2023.pdf    ?
?                                                      ?
?  Arquivo 45 de 120                                  ?
?                                                      ?
???????????????????????????????????????????????????????
```

### Estados Visuais

#### Estado 1: Iniciando (0%)
```
????????????????????????????????????????????
??????????????????????????????????  0.0%  ?
????????????????????????????????????????????
?? Preparando transferência...
```

#### Estado 2: Copiando (45.5%)
```
????????????????????????????????????????????
?????????????????????????????????? 45.5%  ?
????????????????????????????????????????????
?? Copiando: planilha_vendas.xlsx
Arquivo 54 de 120
```

#### Estado 3: Quase Concluindo (95.0%)
```
????????????????????????????????????????????
?????????????????????????????????? 95.0%  ?
????????????????????????????????????????????
?? Copiando: video_grande.mp4
Arquivo 114 de 120
```

#### Estado 4: Completo (100%)
```
????????????????????????????????????????????
?????????????????????????????????? 100.0% ?
????????????????????????????????????????????
? Operação concluída!
```

## ?? Atualização em Tempo Real

### Características

1. **Sem Atraso**
   - Atualização instantânea quando Robocopy processa
   - Usa `DispatcherQueue.TryEnqueue()` para thread-safety
   - Prioridade normal para não travar UI

2. **Thread-Safe**
   ```csharp
   DispatcherQueue.TryEnqueue(() =>
   {
       AppendOutput(e.Data + "\n");
       // Extração de dados...
       UpdateProgress(percent);
       UpdateProgressStatus($"?? Copiando: {fileName}");
   });
   ```

3. **Contador de Arquivos**
   ```csharp
   _processedFiles++;
   if (_totalFiles > 0)
   {
       ProgressDetailsText.Text = $"Arquivo {_processedFiles} de {_totalFiles}";
   }
   ```

## ?? Extração de Dados

### Porcentagem
```csharp
var percentMatch = Regex.Match(e.Data, @"(\d+(?:\.\d+)?)\s*%");
if (percentMatch.Success && double.TryParse(percentMatch.Groups[1].Value, out double percent))
{
    UpdateProgress(percent);
}
```

### Nome do Arquivo
```csharp
// Pattern 1: Formato padrão
var filePattern1 = Regex.Match(
    e.Data, 
    @"^\s*(?:New File|Newer|Older|same|modified|\*EXTRA File)\s+[\d\.,]+\s*[KMG]?B?\s+(.+)$",
    RegexOptions.IgnoreCase
);

// Pattern 2: Caminho completo
var filePattern3 = Regex.Match(
    e.Data,
    @"[A-Za-z]:\\(?:[^\\/:*?""<>|\r\n]+\\)*([^\\/:*?""<>|\r\n]+\.\w+)"
);

// Pattern 3: Final da linha
var filePattern2 = Regex.Match(
    e.Data,
    @"\s+([^\s]+\.\w{2,4})\s*$"
);
```

### Total de Arquivos
```csharp
var totalFilesMatch = Regex.Match(e.Data, @"Files\s*:\s*(\d+)");
if (totalFilesMatch.Success && int.TryParse(totalFilesMatch.Groups[1].Value, out int total))
{
    _totalFiles = total;
}
```

## ? Performance

### Otimizações

1. **Regex Compilados** (futuro): Melhorar performance
2. **Cache de Strings**: Evitar alocações desnecessárias
3. **Throttling**: Limitar atualizações UI se necessário
4. **Prioridade de Dispatcher**: Normal para não bloquear

### Impacto

- **CPU:** Mínimo (< 1% adicional)
- **Memória:** Negligível
- **UI:** Sem travamentos
- **Latência:** < 10ms por atualização

## ?? Tratamento de Erros

### Nomes de Arquivos Longos

```csharp
if (fileName.Length > 50)
{
    fileName = "..." + fileName.Substring(fileName.Length - 47);
}
```

**Exemplo:**
```
Original: "relatorio_completo_de_vendas_do_mes_de_dezembro_de_2023_final_v2.xlsx"
Exibido:  "...o_de_vendas_do_mes_de_dezembro_de_2023_final_v2.xlsx"
```

### Caracteres Especiais

- UTF-8 encoding garante suporte
- Regex ignora caracteres inválidos
- Fallback para padrões alternativos

## ?? Melhorias Futuras

### Em Desenvolvimento

1. **Gráfico de Velocidade** (MB/s em tempo real)
2. **Previsão mais precisa** usando histórico
3. **Pausar/Retomar** com estado salvo
4. **Notificações** de progresso em segundo plano

### Planejadas

1. **Dashboard detalhado** de estatísticas
2. **Comparação** com operações anteriores
3. **Machine Learning** para previsões
4. **Múltiplas operações** com progresso individual

## ?? Exemplo Completo de Log

```
[14:30:00] Iniciando Robocopy...
[14:30:00] Executando: robocopy.exe "C:\Source" "C:\Dest" /E /V /MT:8
[14:30:01] ???????????????????????????????????????????
[14:30:01] ?? Log será salvo em: logs\robocopy_log_20240115_143000.txt
[14:30:02] 
[14:30:02]   Progress: 0.0%
[14:30:02]   ?? Preparando transferência...
[14:30:03] 
[14:30:05]   Progress: 5.2%
[14:30:05]   ?? Copiando: documento1.pdf
[14:30:05]   Arquivo 1 de 120
[14:30:06] 
[14:30:07]   Progress: 12.8%
[14:30:07]   ?? Copiando: planilha_vendas.xlsx
[14:30:07]   Arquivo 15 de 120
[14:30:08] 
[14:30:10]   Progress: 25.0%
[14:30:10]   ?? Copiando: apresentacao.pptx
[14:30:10]   Arquivo 30 de 120
[14:30:11]   ?? Transferindo... 3m 25s restantes
[14:30:15] 
[14:30:15]   Progress: 50.0%
[14:30:15]   ?? Copiando: video_tutorial.mp4
[14:30:15]   Arquivo 60 de 120
[14:30:16]   ?? Transferindo... 1m 45s restantes
[14:30:20] 
[14:30:25]   Progress: 75.0%
[14:30:25]   ?? Copiando: backup_database.bak
[14:30:25]   Arquivo 90 of 120
[14:30:26]   ?? Transferindo... 52s restantes
[14:30:30] 
[14:30:35]   Progress: 95.0%
[14:30:35]   ?? Copiando: imagem_alta_resolucao.tiff
[14:30:35]   Arquivo 114 de 120
[14:30:36]   ?? Transferindo... 15s restantes
[14:30:40] 
[14:30:45]   Progress: 100.0%
[14:30:45]   ? Operação concluída!
[14:30:45] 
[14:30:45] ???????????????????????????????????????????
[14:30:45] Código de saída: 1
[14:30:45] Todos os arquivos foram copiados com sucesso.
```

## ?? Troubleshooting

### Arquivo não aparece

**Causa:** Formato de saída diferente  
**Solução:** Múltiplos patterns cobrem casos diferentes

### Porcentagem não atualiza

**Causa:** Flag `/NP` sendo usada  
**Solução:** RoboCopy-X nunca usa `/NP` (verificado)

### Contador de arquivos não aparece

**Causa:** Robocopy ainda não reportou total  
**Solução:** Normal, aparece após varredura inicial

### Nome truncado incorretamente

**Causa:** Nome > 50 caracteres  
**Solução:** Intencional para melhor UX

---

**Versão:** 1.2.0  
**Última Atualização:** 2024  
**Novidades:** 
- ? Detecção de arquivos em tempo real
- ? Múltiplos padrões regex
- ? Contador de arquivos
- ? Ícones visuais
- ? Interface melhorada

**Autor:** RoboCopy-X Team
